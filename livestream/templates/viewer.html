<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Device Viewer</title>
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: 'Segoe UI', Arial, sans-serif;
        background-color: #0e0e0e;
        color: #f5f5f5;
        margin: 0;
        padding: 20px;
      }

      .viewer-card {
        max-width: 850px;
        margin: auto;
        background: #1a1a1a;
        border-radius: 14px;
        padding: 25px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.6);
        border: 1px solid rgba(255, 215, 0, 0.15);
      }

      h3 {
        color: #ffd700;
        text-align: center;
        font-weight: 600;
        margin-bottom: 15px;
        letter-spacing: 0.5px;
      }

      .status {
        text-align: center;
        font-style: italic;
        margin-bottom: 15px;
        color: #ccc;
      }

      video {
        width: 33%;
        max-width: 650px;
        border-radius: 10px;
        border: 2px solid #ffd700;
        background-color: black;
        display: block;
        margin: auto;
        box-shadow: 0 0 15px rgba(255, 215, 0, 0.2);
      }

      audio {
        display: none;
      }

      .btn-custom {
        background: linear-gradient(90deg, #ffd700, #e6b800);
        color: #121212;
        font-weight: bold;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        transition: all 0.3s ease;
      }

      .btn-custom:hover {
        background: linear-gradient(90deg, #0dcaf0, #0a9bc7);
        color: #fff;
        box-shadow: 0 0 10px rgba(13, 202, 240, 0.6);
      }

      #refreshBtn {
        background: none;
        border: none;
        font-size: 1.5rem;
        color: #ffd700;
        cursor: pointer;
        transition: transform 0.2s ease, color 0.2s ease;
      }

      #refreshBtn:hover {
        transform: rotate(90deg);
        color: #0dcaf0;
      }

      .top-bar {
        display: flex;
        justify-content: flex-end;
        margin-bottom: 10px;
      }

      .control-buttons {
        text-align: center;
        margin-top: 15px;
        display: flex;
        justify-content: center;
        gap: 10px;
        flex-wrap: wrap;
      }

      #switchCameraBtn {
        background: linear-gradient(90deg, #555, #333);
        color: white;
      }
      #switchCameraBtn:hover {
        background: linear-gradient(90deg, #0dcaf0, #0a9bc7);
      }
    </style>
  </head>
  <body>
    <div class="top-bar">
      <button id="refreshBtn" title="Refresh Devices">♻️</button>
    </div>

    <div class="viewer-card">
      <h3>⛏ Device Viewer</h3>
      <p class="status" id="status">Loading...</p>

      <video id="remoteVideo" playsinline autoplay></video>
      <audio id="remoteAudio" autoplay></audio>

      <div class="control-buttons">
        <button id="startButton" class="btn btn-custom">Start Stream</button>
        <button
          style="display: none !important"
          id="micButton"
          class="btn btn-custom"
        >
          Enable Microphone
        </button>
        <button
          id="switchCameraBtn"
          class="btn btn-custom"
          style="display: none"
        >
          Switch Camera
        </button>
      </div>
    </div>

    <script>
      const socket = io();
      let pc = null;
      let deviceId = null;
      let adminId = null;
      let localStream = null;
      let isMicActive = false;
      let adminAudioStream = null; // Track the admin's microphone stream

      let micStream = null;
      let micMuted = false;
      let speakerMuted = false;
      let audioSender = null; // Track the audio sender for muting

      // Get device ID from URL parameter
      const urlParams = new URLSearchParams(window.location.search);
      deviceId = urlParams.get('device');

      if (!deviceId) {
        document.getElementById('status').textContent =
          'Error: No device specified in URL. Use ?device=DEVICE_ID';
      } else {
        document.getElementById(
          'status'
        ).textContent = `Checking status of device: ${deviceId}...`;

        // Emit a request to check if the device is online
        socket.emit('check_device_status', { deviceId });

        socket.on('device_status', (data) => {
          if (data.deviceId === deviceId) {
            if (data.online) {
              document.getElementById(
                'status'
              ).innerHTML = `Device <strong>${deviceId}</strong> is <span style="color: green;">Online</span>. Initializing stream...`;
              // **MODIFICATION HERE: Automatically start the stream**
              setupWebRTC();
            } else {
              document.getElementById(
                'status'
              ).innerHTML = `Device <strong>${deviceId}</strong> is <span style="color: red;">Offline</span>`;
            }
          }
        });

        socket.on('connect', () => {
          adminId = socket.id;
          console.log('Viewer connected with id:', adminId);
          // Register as admin so refresh works
          socket.emit('join_admin');
        });

        async function setupWebRTC() {
          document.getElementById(
            'status'
          ).textContent = `Connecting to device: ${deviceId}`;
          // Hide the start button as we are auto-starting
          document.getElementById('startButton').style.display = 'none';
          document.getElementById('micButton').style.display = 'none';

          pc = new RTCPeerConnection({
            iceServers: [
              { urls: ['stun:ss-turn1.xirsys.com'] },
              {
                username:
                  '84jBdtXd3EWm7_60Y6c7HxgYV0Cqwo2hNpN9oEbYhdvSxLU-qeTd9Oz3Ll_zm3U0AAAAAGfemddyYW1lc2hyb3k2Ng==',
                credential: 'c8a6bfd4-070d-11f0-ac2d-0242ac140004',
                urls: [
                  'turn:ss-turn1.xirsys.com:80?transport=udp',
                  'turn:ss-turn1.xirsys.com:3478?transport=udp',
                  'turn:ss-turn1.xirsys.com:80?transport=tcp',
                  'turn:ss-turn1.xirsys.com:3478?transport=tcp',
                  'turns:ss-turn1.xirsys.com:443?transport=tcp',
                  'turns:ss-turn1.xirsys.com:5349?transport=tcp',
                ],
              },
            ],
          });

          // Try to get microphone, but don't stop if it fails
          try {
            micStream = await navigator.mediaDevices.getUserMedia({
              audio: true,
            });
            const audioTracks = micStream.getAudioTracks();
            if (audioTracks.length > 0) {
              audioSender = pc.addTrack(audioTracks[0], micStream);
            }
          } catch (err) {
            console.warn('Microphone not available:', err);
            document.getElementById(
              'status'
            ).innerHTML += `<br><span style="color: orange;">⚠ No microphone access — audio sending disabled</span>`;
          }

          // Handle remote video/audio
          pc.ontrack = (event) => {
            const remoteVideo = document.getElementById('remoteVideo');
            const remoteAudio = document.getElementById('remoteAudio');

            event.streams.forEach((stream) => {
              if (stream.getVideoTracks().length > 0) {
                remoteVideo.srcObject = stream;
              }
              if (stream.getAudioTracks().length > 0) {
                remoteAudio.srcObject = stream;
              }
            });

            document.getElementById(
              'status'
            ).textContent = `Connected to device: ${deviceId}`;
            document.getElementById('switchCameraBtn').style.display = 'block';
          };

          pc.onicecandidate = (event) => {
            if (event.candidate) {
              socket.emit('webrtc_candidate', {
                target: deviceId,
                candidate: event.candidate,
                from: adminId,
              });
            }
          };

          // Add receivers
          pc.addTransceiver('video', { direction: 'recvonly' });
          pc.addTransceiver('audio', { direction: 'sendrecv' });

          // Create offer and send
          try {
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            socket.emit('webrtc_offer', {
              target: deviceId,
              offer: pc.localDescription,
              from: adminId,
            });
          } catch (err) {
            console.error('Error creating offer:', err);
            document.getElementById(
              'status'
            ).textContent = `Error connecting to device: ${err.message}`;
            // Optionally show the button again on failure
            document.getElementById('startButton').style.display = 'block';
          }
        }

        // Refresh button functionality
        document.getElementById('refreshBtn').addEventListener('click', () => {
          socket.emit('refresh_command');
        });

        // The startButton listener is now a fallback in case of an error
        document.getElementById('startButton').addEventListener('click', () => {
          setupWebRTC();
        });

        socket.on('webrtc_answer', async (data) => {
          if (data.from === deviceId && pc) {
            try {
              await pc.setRemoteDescription(
                new RTCSessionDescription(data.answer)
              );
              console.log('Remote description set successfully');
            } catch (err) {
              console.error('Error setting remote description:', err);
            }
          }
        });

        socket.on('webrtc_candidate', async (data) => {
          if (data.from === deviceId && pc && data.candidate) {
            try {
              await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
              console.log('Added ICE candidate successfully');
            } catch (err) {
              console.error('Error adding ICE candidate:', err);
            }
          }
        });

        document
          .getElementById('switchCameraBtn')
          .addEventListener('click', () => {
            if (!deviceId) {
              alert('No device selected.');
              return;
            }
            if (!pc || pc.connectionState !== 'connected') {
              alert('No active connection to device.');
              return;
            }

            const btn = document.getElementById('switchCameraBtn');
            btn.disabled = true;
            btn.innerHTML = `
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            Switching...
        `;

            socket.emit('switch_camera', {
              target: deviceId,
              from: adminId,
            });

            setTimeout(() => {
              btn.disabled = false;
              btn.innerHTML = 'Switch Camera';

              // Add temporary success feedback
              btn.classList.add('switch-success');
              setTimeout(() => btn.classList.remove('switch-success'), 1000);
            }, 2000);
          });

        socket.on('disconnect', () => {
          document.getElementById('status').textContent =
            'Disconnected from server';
          document.getElementById('startButton').style.display = 'block';
          document.getElementById('micButton').style.display = 'none';
        });
      }

      remoteVideo.addEventListener('play', () => {
        remoteVideo.classList.add('playing');
      });

      // These listeners are not in your original code but were in the prompt.
      // Make sure you have corresponding HTML elements if you want to use them.
      const toggleMicBtn = document.getElementById('toggleMic');
      if (toggleMicBtn) {
          toggleMicBtn.addEventListener('click', () => {
            if (!audioSender) return;

            micMuted = !micMuted;
            if (audioSender.track) {
              audioSender.track.enabled = !micMuted;
            }
            toggleMicBtn.textContent = micMuted
              ? 'Unmute Microphone'
              : 'Mute Microphone';
          });
      }

      const toggleSpeakerBtn = document.getElementById('toggleSpeaker');
      if (toggleSpeakerBtn) {
          toggleSpeakerBtn.addEventListener('click', () => {
            const audioPlayer = document.getElementById('remoteAudio');
            speakerMuted = !speakerMuted;
            audioPlayer.muted = speakerMuted;
            toggleSpeakerBtn.textContent = speakerMuted
              ? 'Unmute Speaker'
              : 'Mute Speaker';
          });
      }
    </script>
  </body>
</html>
