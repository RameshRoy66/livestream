<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Durga Coal Mining Pvt. Ltd. – Admin Panel</title>
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <style>
      :root {
        --primary: #2c3e50;
        --secondary: #ffcc00;
        --accent: #3498db;
        --dark: #1e1e1e;
        --light: #f4f6f9;
        --danger: #e74c3c;
        --success: #2ecc71;
        --warning: #f39c12;
        --gray: #95a5a6;
      }

      body {
        margin: 0;
        font-family: 'Segoe UI', sans-serif;
        background-color: var(--light);
        color: #333;
      }

      /* Sidebar */
      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 280px;
        height: 100vh;
        background: var(--dark);
        color: #fff;
        padding: 20px;
        overflow-y: auto;
        border-right: 3px solid var(--secondary);
        z-index: 1000;
        transition: all 0.3s ease;
      }

      .sidebar-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .sidebar h3 {
        color: var(--secondary);
        margin: 0;
        font-size: 20px;
      }

      .toggle-sidebar {
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        font-size: 20px;
      }

      .search-box {
        margin-bottom: 20px;
        position: relative;
      }

      .search-box input {
        width: 100%;
        padding: 10px 15px 10px 40px;
        border-radius: 6px;
        border: none;
        outline: none;
        background: rgba(255, 255, 255, 0.1);
        color: white;
      }

      .search-box i {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--gray);
      }

      .device-list {
        max-height: 250px;
        overflow-y: scroll;
        padding-right: 5px;
        margin-bottom: 20px;
      }

      .device-list::-webkit-scrollbar {
        width: 6px;
      }

      .device-list::-webkit-scrollbar-thumb {
        background: var(--secondary);
        border-radius: 10px;
      }

      .device-item {
        display: flex;
        align-items: center;
        padding: 10px;
        margin-bottom: 8px;
        font-size: 14px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 6px;
        transition: all 0.2s;
      }

      .device-item:hover {
        background: rgba(255, 255, 255, 0.1);
      }

      .device-item label {
        margin-left: 8px;
        cursor: pointer;
        flex: 1;
      }

      .device-status {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 10px;
        background: var(--gray);
      }

      .device-status.connected {
        background: var(--success);
      }

      .device-status.disconnected {
        background: var(--danger);
      }

      .sidebar-footer {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
      }

      .btn-sidebar {
        width: 100%;
        margin-bottom: 10px;
        padding: 10px;
        border-radius: 6px;
        background: var(--secondary);
        color: #121212;
        border: none;
        font-weight: bold;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }
      .rbtn {
        width: 50px;
        padding: 10px;
        background: var(--secondary);
        height: 44px;
        border-radius: 6px;
        border: none;
        transition: all 0.2s;
      }

      .btn-sidebar:hover:not(:disabled) {
        background: var(--accent);
        color: #fff;
      }

      .btn-sidebar:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .btn-sidebar.switch-all {
        background: var(--success);
        color: white;
      }

      /* Main Content */
      .main-content {
        margin-left: 280px;
        padding: 20px;
        transition: all 0.3s ease;
      }

      .main-content.expanded {
        margin-left: 0;
      }

      .page-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 25px;
        padding: 15px 20px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      }

      .page-header h2 {
        font-weight: bold;
        color: var(--primary);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .connection-status {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 14px;
        color: var(--gray);
      }

      .status-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: var(--success);
      }

      .status-indicator.offline {
        background: var(--danger);
      }

      .streams-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 20px;
      }

      .device-card {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        transition: all 0.3s ease;
      }

      .device-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      }

      .card-header {
        background: var(--primary);
        color: white;
        padding: 15px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .device-name {
        font-weight: bold;
        font-size: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .device-actions {
        display: flex;
        gap: 10px;
      }

      .card-body {
        padding: 0;
        position: relative;
      }

      video {
        width: 100%;
        height: 400px;
        /* object-fit: cover; */
        background: #000;
        display: block;
      }

      .video-placeholder {
        width: 100%;
        height: 200px;
        background: #000;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        flex-direction: column;
        gap: 10px;
      }

      .video-controls {
        padding: 15px;
        display: flex;
        justify-content: center;
        gap: 10px;
      }

      .btn-control {
        padding: 8px 15px;
        border-radius: 6px;
        border: none;
        font-weight: bold;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 5px;
        cursor: pointer;
      }

      .btn-control:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .btn-switch {
        background: var(--accent);
        color: white;
      }

      .btn-switch:hover:not(:disabled) {
        background: #2980b9;
      }

      .btn-audio {
        background: var(--gray);
        color: white;
      }

      .btn-audio:hover:not(:disabled) {
        background: #7f8c8d;
      }

      .btn-audio.muted {
        background: var(--danger);
      }

      .notification-toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: var(--dark);
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        display: flex;
        align-items: center;
        gap: 10px;
        z-index: 2000;
        transform: translateY(100px);
        opacity: 0;
        transition: all 0.3s ease;
      }

      .notification-toast.show {
        transform: translateY(0);
        opacity: 1;
      }

      .notification-icon {
        font-size: 20px;
      }

      .notification-success {
        border-left: 4px solid var(--success);
      }

      .notification-error {
        border-left: 4px solid var(--danger);
      }

      .notification-warning {
        border-left: 4px solid var(--warning);
      }

      /* Responsive */
      @media (max-width: 992px) {
        .sidebar {
          transform: translateX(-100%);
        }

        .sidebar.show {
          transform: translateX(0);
        }

        .main-content {
          margin-left: 0;
        }

        .streams-container {
          grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        }
      }

      /* Loading animation */
      .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: var(--secondary);
        animation: spin 1s ease-in-out infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .pulse {
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }
    </style>
  </head>
  <body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h3><i class="fas fa-hard-hat"></i> Device Controls</h3>
        <button class="toggle-sidebar" id="toggleSidebar">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div style="display: flex; gap: 2px">
        <div class="search-box" title="Search Vehicle">
          <i class="fas fa-search"></i>
          <input
            type="text"
            id="deviceSearch"
            placeholder="Search devices..."
          />
        </div>
        <button id="selectAllBtn" class="rbtn" title="select all">
          <i class="fas fa-check-square"></i>
        </button>
      </div>

      <div class="device-list" id="deviceList">
        <!-- Devices with checkboxes will be inserted here -->
      </div>
      <div
        class="text-center text-muted py-3"
        id="noDevicesMessage"
        style="display: none; color: white !important"
      >
        <i class="fas fa-exclamation-circle"></i>
        <p>No devices found</p>
      </div>

      <div class="sidebar-footer">
        <!-- <button id="selectAllBtn2" class="btn-sidebar">
          <i class="fas fa-check-square"></i> Select All
        </button> -->
        <button id="submitBtn" class="btn-sidebar">
          <i class="fas fa-play"></i> View Selected
        </button>
        <button id="switchAllBtn" class="btn-sidebar switch-all">
          <i class="fas fa-sync"></i> Switch All Cameras
        </button>
        <button
          id="clearAllBtn"
          class="btn-sidebar"
          style="background: var(--danger); color: white"
        >
          <i class="fas fa-trash"></i> Clear All Streams
        </button>
        <!-- <button id="audioToggle" class="btn-sidebar">
          <i class="fas fa-microphone"></i> Toggle Audio
        </button> -->
        <button id="refreshBtn" class="btn-sidebar">Refresh Devices</button>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
      <div class="page-header">
        <h2>
          <i class="fas fa-video"></i> Admin Panel – Durga Coal Mining Pvt. Ltd.
        </h2>
        <div class="connection-status">
          <span id="connectionStatus">Connected</span>
          <div class="status-indicator" id="statusIndicator"></div>
        </div>
      </div>

      <div id="streamsContainer" class="streams-container">
        <!-- Device cards will be inserted here -->
      </div>

      <div class="welcome-message" id="welcomeMessage">
        <div class="alert alert-info">
          <h4><i class="fas fa-info-circle"></i> Getting Started</h4>
          <p>
            <h6 class="mb-2">Quick steps</h6>
              <ol class="quick-steps mb-0">
                <li>Use the search or filters to find your devices.</li>
                <li>Tick the checkboxes to select one or more devices.</li>
                <li>Click <strong>View Selected</strong> to open the monitoring view.</li>
              </ol>
          </p>
        </div>
      </div>



    </div>

    <!-- Notification Toast -->
    <div class="notification-toast" id="notificationToast">
      <div class="notification-icon" id="toastIcon"></div>
      <div class="notification-content">
        <div id="toastMessage">Notification message</div>
      </div>
    </div>

    <script>
      const socket = io();
      let adminId = null;
      let devices = [];
      let deviceStatus = {};
      let selectedDevices = [];
      let connections = {};
      let adminAudioStream = null;
      let audioEnabled = true;
      let retryAttempts = {};
      const MAX_RETRY_ATTEMPTS = 3;

      const configuration = {
        iceServers: [
          { urls: ['stun:ss-turn1.xirsys.com'] },
          {
            username:
              '84jBdtXd3EWm7_60Y6c7HxgYV0Cqwo2hNpN9oEbYhdvSxLU-qeTd9Oz3Ll_zm3U0AAAAAGfemddyYW1lc2hyb3k2Ng==',
            credential: 'c8a6bfd4-070d-11f0-ac2d-0242ac140004',
            urls: [
              'turn:ss-turn1.xirsys.com:80?transport=udp',
              'turn:ss-turn1.xirsys.com:3478?transport=udp',
              'turn:ss-turn1.xirsys.com:80?transport=tcp',
              'turn:ss-turn1.xirsys.com:3478?transport=tcp',
              'turns:ss-turn1.xirsys.com:443?transport=tcp',
              'turns:ss-turn1.xirsys.com:5349?transport=tcp',
            ],
          },
        ],
      };

      // Initialize the application
      function init() {
        setupEventListeners();
        updateConnectionStatus(true);
      }

      // Refresh button functionality
      document.getElementById('refreshBtn').addEventListener('click', () => {
        socket.emit('refresh_command');
      });

      // Set up all event listeners
      function setupEventListeners() {
        // Socket events
        socket.on('connect', onSocketConnect);
        socket.on('disconnect', onSocketDisconnect);
        socket.on('update_device_list', onDeviceListUpdate);
        socket.on('webrtc_answer', onWebRTCAnswer);
        socket.on('webrtc_candidate', onWebRTCCandidate);
        socket.on('device_status', onDeviceStatusUpdate);

        // UI events
        document
          .getElementById('deviceSearch')
          .addEventListener('input', onDeviceSearch);
        document
          .getElementById('selectAllBtn')
          .addEventListener('click', onSelectAll);
        document
          .getElementById('submitBtn')
          .addEventListener('click', onSubmitDevices);
        document
          .getElementById('clearAllBtn')
          .addEventListener('click', onClearAllStreams);
        document
          .getElementById('switchAllBtn')
          .addEventListener('click', onSwitchAllCameras);
        document
          .getElementById('audioToggle')
          .addEventListener('click', onToggleAudio);
        document
          .getElementById('toggleSidebar')
          .addEventListener('click', onToggleSidebar);
        document
          .getElementById('refreshBtn')
          .addEventListener('click', onRefreshDevices);

        // Handle window resize for responsive sidebar
        window.addEventListener('resize', onWindowResize);

        console.log('Event listeners set up successfully');
      }

      // Socket connection established
      function onSocketConnect() {
        adminId = socket.id;
        socket.emit('join_admin');
        updateConnectionStatus(true);
        showNotification('Connected to server', 'success');
      }

      // Socket disconnected
      function onSocketDisconnect() {
        updateConnectionStatus(false);
        showNotification('Disconnected from server', 'error');
      }

      // Device list updated from server
      function onDeviceListUpdate(list) {
        devices = list;
        renderDeviceList(list);
      }

      // Device status updated
      function onDeviceStatusUpdate(data) {
        deviceStatus[data.deviceId] = data.status;
        updateDeviceStatusIndicator(data.deviceId, data.status);
      }

      // WebRTC answer received
      async function onWebRTCAnswer(data) {
        const pc = connections[data.from];
        if (pc) {
          try {
            await pc.setRemoteDescription(
              new RTCSessionDescription(data.answer)
            );
            retryAttempts[data.from] = 0; // Reset retry counter on success
          } catch (error) {
            console.error('Error setting remote description:', error);
            showNotification(`Error connecting to ${data.from}`, 'error');
          }
        }
      }

      // WebRTC candidate received
      async function onWebRTCCandidate(data) {
        const pc = connections[data.from];
        if (pc && data.candidate) {
          try {
            await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
          } catch (error) {
            console.error('Error adding ice candidate:', error);
          }
        }
      }

      // Filter device list based on search input
      function onDeviceSearch(e) {
        const query = e.target.value.toLowerCase();

        if (!devices || devices.length === 0) {
          renderDeviceList([]);
          return;
        }

        // Filter devices based on search query
        const filtered = devices.filter((device) => {
          const deviceId =
            typeof device === 'string' ? device : device.id || '';
          return deviceId.toLowerCase().includes(query);
        });

        renderDeviceList(filtered);
      }

      // Select all devices
      function onSelectAll() {
        // disableButton('selectAllBtn', 2000);
        const allChecked =
          document.querySelectorAll('.device-checkbox:checked').length ===
          devices.length;

        document.querySelectorAll('.device-checkbox').forEach((cb) => {
          cb.checked = !allChecked;
        });

        showNotification(
          allChecked ? 'All devices deselected' : 'All devices selected',
          'success'
        );
      }

      // Submit selected devices for viewing
      // Submit selected devices for viewing
      async function onSubmitDevices() {
        // disableButton('submitBtn', 2000);
        const newSelectedDevices = Array.from(
          document.querySelectorAll('.device-checkbox:checked')
        ).map((cb) => cb.value);

        // Close all existing connections regardless of whether we have new devices
        closeAllConnections();

        // Update selected devices
        selectedDevices = newSelectedDevices;

        if (selectedDevices.length === 0) {
          showNotification('No devices selected - clearing view', 'warning');
          // Clear the container and show welcome message
          const container = document.getElementById('streamsContainer');
          container.innerHTML = '';
          const welcomeMessage = document.getElementById('welcomeMessage');
          welcomeMessage.style.display = 'block';
          return;
        }

        showNotification(
          `Loading ${selectedDevices.length} device(s)`,
          'success'
        );
        await loadSelectedDevices();
      }

      // Clear all streams and show welcome message
      // Clear all streams and show welcome message
      function onClearAllStreams() {
        console.log('Clear All Streams button clicked');
        disableButton('clearAllBtn', 2000);

        // Close all WebRTC connections
        closeAllConnections();

        // Clear selected devices
        selectedDevices = [];

        // Uncheck all checkboxes
        document
          .querySelectorAll('.device-checkbox:checked')
          .forEach((checkbox) => {
            checkbox.checked = false;
          });

        // Clear the streams container
        const container = document.getElementById('streamsContainer');
        container.innerHTML = '';

        // Show welcome message
        const welcomeMessage = document.getElementById('welcomeMessage');
        if (welcomeMessage) {
          welcomeMessage.style.display = 'block';
        }

        showNotification('All streams cleared', 'success');
        console.log('All streams cleared successfully');
      }
      // Close all WebRTC connections
      // Close all WebRTC connections
      // Close all WebRTC connections
      function closeAllConnections() {
        Object.keys(connections).forEach((deviceId) => {
          if (connections[deviceId]) {
            // Close the connection
            connections[deviceId].close();

            // Stop all tracks in the stream
            const videoElement = document.getElementById(`video_${deviceId}`);
            if (videoElement && videoElement.srcObject) {
              videoElement.srcObject
                .getTracks()
                .forEach((track) => track.stop());
            }
          }
        });

        // Clear connections object
        connections = {};
        retryAttempts = {};
      }

      // Switch all cameras
      function onSwitchAllCameras() {
        disableButton('switchAllBtn', 5000);

        if (selectedDevices.length === 0) {
          showNotification('No devices selected', 'warning');
          return;
        }

        selectedDevices.forEach((d) => {
          switchCamera(d);
        });

        showNotification('Switching all cameras', 'success');
      }

      // Toggle audio
      async function onToggleAudio() {
        audioEnabled = !audioEnabled;
        const button = document.getElementById('audioToggle');

        if (audioEnabled) {
          try {
            adminAudioStream = await navigator.mediaDevices.getUserMedia({
              audio: true,
            });
            button.innerHTML =
              '<i class="fas fa-microphone-slash"></i> Disable Audio';
            showNotification('Audio enabled', 'success');
          } catch (err) {
            audioEnabled = false;
            showNotification('Microphone access denied', 'error');
          }
        } else {
          if (adminAudioStream) {
            adminAudioStream.getTracks().forEach((track) => track.stop());
            adminAudioStream = null;
          }
          button.innerHTML = '<i class="fas fa-microphone"></i> Enable Audio';
          showNotification('Audio disabled', 'success');
        }

        // Update audio tracks for all active connections
        Object.keys(connections).forEach((deviceId) => {
          updateAudioTracks(deviceId);
        });
      }

      // Toggle sidebar visibility on mobile
      function onToggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.toggle('show');
      }

      // Handle window resize
      function onWindowResize() {
        // Auto-hide sidebar on mobile when resizing to larger screen
        if (window.innerWidth >= 992) {
          document.getElementById('sidebar').classList.remove('show');
        }
      }

      // Render device list in sidebar
      function renderDeviceList(list) {
        const container = document.getElementById('deviceList');
        const noDevicesMessage = document.getElementById('noDevicesMessage');

        // Always clear the container first
        container.innerHTML = '';

        if (list.length === 0) {
          noDevicesMessage.style.display = 'block';
          return;
        }

        noDevicesMessage.style.display = 'none';

        list.forEach((device) => {
          // Extract device ID whether device is a string or object
          const deviceId =
            typeof device === 'string' ? device : device.id || 'Unknown';
          const displayName =
            typeof device === 'string'
              ? device
              : device.name || device.id || 'Unknown Device';

          const div = document.createElement('div');
          div.className = 'device-item';
          div.innerHTML = `
      <div class="device-status ${
        deviceStatus[deviceId] === 'connected' ? 'connected' : 'disconnected'
      }"></div>
      <input type="checkbox" class="form-check-input device-checkbox" value="${deviceId}">
      <label>${displayName}</label>
    `;
          container.appendChild(div);
        });
      }

      // Load selected devices and establish connections
      // Load selected devices and establish connections
      // Load selected devices and establish connections
      async function loadSelectedDevices() {
        const container = document.getElementById('streamsContainer');
        const welcomeMessage = document.getElementById('welcomeMessage');

        // Always clear the container first
        container.innerHTML = '';

        if (selectedDevices.length > 0) {
          welcomeMessage.style.display = 'none';

          // Try to get mic access if audio is enabled
          if (!adminAudioStream && audioEnabled) {
            try {
              adminAudioStream = await navigator.mediaDevices.getUserMedia({
                audio: true,
              });
            } catch (err) {
              audioEnabled = false;
              showNotification(
                'Microphone not available - streaming video only',
                'warning'
              );
            }
          }

          // Create device cards and WebRTC connections
          selectedDevices.forEach(async (device) => {
            // Create device card UI
            const card = createDeviceCard(device);
            container.appendChild(card);

            // Initialize WebRTC connection
            await initWebRTCConnection(device);
          });
        } else {
          // If no devices selected, show welcome message
          welcomeMessage.style.display = 'block';
        }
      }

      // Create device card element
      function createDeviceCard(deviceId) {
        const card = document.createElement('div');
        card.className = 'device-card';
        card.id = `card_${deviceId}`;
        card.innerHTML = `
          <div class="card-header">
            <div class="device-name">
              <i class="fas fa-video"></i> ${deviceId}
            </div>
            <div class="device-actions">
              <span class="badge bg-secondary" id="statusBadge_${deviceId}">Connecting...</span>
            </div>
          </div>
          <div class="card-body">
            <div class="video-placeholder" id="placeholder_${deviceId}">
              <div class="spinner"></div>
              <p>Connecting to device...</p>
            </div>
            <video id="video_${deviceId}" autoplay playsinline style="display: none;"></video>
          </div>
          <div class="video-controls">
            <button class="btn-control btn-switch" onclick="switchCamera('${deviceId}')" id="switchBtn_${deviceId}">
              <i class="fas fa-sync"></i> Switch Camera
            </button>
            <button class="btn-control btn-audio d-none" onclick="toggleDeviceAudio('${deviceId}')" id="audioBtn_${deviceId}">
              <i class="fas fa-volume-up"></i> Audio
            </button>
          </div>
        `;
        return card;
      }

      // Initialize WebRTC connection for a device
      async function initWebRTCConnection(deviceId) {
        try {
          // Initialize retry attempts counter
          if (!retryAttempts[deviceId]) {
            retryAttempts[deviceId] = 0;
          }

          // Create peer connection
          const pc = new RTCPeerConnection(configuration);
          connections[deviceId] = pc;

          // Add audio tracks if available
          if (adminAudioStream) {
            adminAudioStream.getTracks().forEach((track) => {
              pc.addTrack(track, adminAudioStream);
            });
          }

          // Add video transceiver
          pc.addTransceiver('video', { direction: 'recvonly' });

          // Handle incoming tracks
          pc.ontrack = (event) => {
            const videoElement = document.getElementById(`video_${deviceId}`);
            const placeholder = document.getElementById(
              `placeholder_${deviceId}`
            );

            if (videoElement && event.streams && event.streams[0]) {
              videoElement.srcObject = event.streams[0];
              videoElement.style.display = 'block';
              placeholder.style.display = 'none';
              updateDeviceStatus(deviceId, 'connected');
            }
          };

          // Handle ICE candidates
          pc.onicecandidate = (event) => {
            if (event.candidate) {
              socket.emit('webrtc_candidate', {
                target: deviceId,
                candidate: event.candidate,
                from: adminId,
              });
            }
          };

          // Handle connection state changes
          pc.onconnectionstatechange = () => {
            console.log(
              `Connection state for ${deviceId}: ${pc.connectionState}`
            );
            if (pc.connectionState === 'connected') {
              updateDeviceStatus(deviceId, 'connected');
            } else if (
              pc.connectionState === 'disconnected' ||
              pc.connectionState === 'failed'
            ) {
              updateDeviceStatus(deviceId, 'disconnected');
              attemptReconnection(deviceId);
            }
          };

          // Create and send offer
          const offer = await pc.createOffer();
          await pc.setLocalDescription(offer);

          socket.emit('webrtc_offer', {
            target: deviceId,
            offer: offer,
            from: adminId,
          });

          // Set timeout to check if connection is established
          setTimeout(() => {
            if (pc.connectionState !== 'connected') {
              updateDeviceStatus(deviceId, 'connecting');
            }
          }, 5000);
        } catch (error) {
          console.error(`Error initializing WebRTC for ${deviceId}:`, error);
          updateDeviceStatus(deviceId, 'error');
          showNotification(`Failed to connect to ${deviceId}`, 'error');
        }
      }

      // Attempt to reconnect to a device
      function attemptReconnection(deviceId) {
        if (retryAttempts[deviceId] < MAX_RETRY_ATTEMPTS) {
          retryAttempts[deviceId]++;

          setTimeout(async () => {
            if (connections[deviceId]) {
              // Close old connection
              connections[deviceId].close();
              delete connections[deviceId];
            }

            // Try to reconnect
            showNotification(
              `Reconnecting to ${deviceId} (${retryAttempts[deviceId]}/${MAX_RETRY_ATTEMPTS})`,
              'warning'
            );
            await initWebRTCConnection(deviceId);
          }, 3000 * retryAttempts[deviceId]); // Exponential backoff
        } else {
          showNotification(
            `Failed to connect to ${deviceId} after ${MAX_RETRY_ATTEMPTS} attempts`,
            'error'
          );
        }
      }

      // Switch camera for a device
      function switchCamera(deviceId) {
        disableButton(`switchBtn_${deviceId}`, 5000);
        socket.emit('switch_camera', { target: deviceId, from: adminId });
        showNotification(`Switching camera for ${deviceId}`, 'success');
      }

      // Toggle audio for a specific device
      function toggleDeviceAudio(deviceId) {
        const button = document.getElementById(`audioBtn_${deviceId}`);
        const pc = connections[deviceId];

        if (pc) {
          const senders = pc.getSenders();
          const audioSender = senders.find(
            (sender) => sender.track && sender.track.kind === 'audio'
          );

          if (audioSender) {
            audioSender.track.enabled = !audioSender.track.enabled;
            const isEnabled = audioSender.track.enabled;

            button.innerHTML = isEnabled
              ? '<i class="fas fa-volume-up"></i> Audio'
              : '<i class="fas fa-volume-mute"></i> Muted';

            button.classList.toggle('muted', !isEnabled);
            showNotification(
              `${isEnabled ? 'Enabled' : 'Disabled'} audio for ${deviceId}`,
              'success'
            );
          }
        }
      }

      // Update audio tracks for a connection
      function updateAudioTracks(deviceId) {
        const pc = connections[deviceId];
        if (!pc) return;

        const senders = pc.getSenders();
        const audioSender = senders.find(
          (sender) => sender.track && sender.track.kind === 'audio'
        );

        // Remove existing audio track
        if (audioSender) {
          pc.removeTrack(audioSender);
        }

        // Add new audio track if audio is enabled
        if (audioEnabled && adminAudioStream) {
          const audioTrack = adminAudioStream.getAudioTracks()[0];
          if (audioTrack) {
            pc.addTrack(audioTrack, adminAudioStream);
          }
        }
      }

      // Update device status in UI
      function updateDeviceStatus(deviceId, status) {
        const badge = document.getElementById(`statusBadge_${deviceId}`);
        if (!badge) return;

        deviceStatus[deviceId] = status;

        switch (status) {
          case 'connected':
            badge.className = 'badge bg-success';
            badge.textContent = 'Live';
            break;
          case 'connecting':
            badge.className = 'badge bg-warning';
            badge.textContent = 'Connecting...';
            break;
          case 'disconnected':
            badge.className = 'badge bg-danger';
            badge.textContent = 'Disconnected';
            break;
          case 'error':
            badge.className = 'badge bg-danger';
            badge.textContent = 'Error';
            break;
        }
      }

      // Update device status indicator in sidebar
      function updateDeviceStatusIndicator(deviceId, status) {
        const deviceItems = document.querySelectorAll('.device-item');
        deviceItems.forEach((item) => {
          const checkbox = item.querySelector('.device-checkbox');
          if (checkbox && checkbox.value === deviceId) {
            const statusIndicator = item.querySelector('.device-status');
            if (statusIndicator) {
              statusIndicator.className = `device-status ${
                status === 'connected' ? 'connected' : 'disconnected'
              }`;
            }
          }
        });
      }

      // Update connection status indicator
      function updateConnectionStatus(isConnected) {
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('connectionStatus');

        if (isConnected) {
          statusIndicator.className = 'status-indicator';
          statusText.textContent = 'Connected';
          statusText.style.color = '';
        } else {
          statusIndicator.className = 'status-indicator offline';
          statusText.textContent = 'Disconnected';
          statusText.style.color = 'var(--danger)';
        }
      }

      // Disable a button for a specified time
      function disableButton(buttonId, duration) {
        const button = document.getElementById(buttonId);
        if (!button) return;

        button.disabled = true;

        setTimeout(() => {
          button.disabled = false;
        }, duration);
      }

      // Show notification toast
      function showNotification(message, type = 'info') {
        const toast = document.getElementById('notificationToast');
        const toastIcon = document.getElementById('toastIcon');
        const toastMessage = document.getElementById('toastMessage');

        // Set icon based on type
        switch (type) {
          case 'success':
            toastIcon.innerHTML = '<i class="fas fa-check-circle"></i>';
            toast.className = 'notification-toast notification-success';
            break;
          case 'error':
            toastIcon.innerHTML = '<i class="fas fa-exclamation-circle"></i>';
            toast.className = 'notification-toast notification-error';
            break;
          case 'warning':
            toastIcon.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
            toast.className = 'notification-toast notification-warning';
            break;
          default:
            toastIcon.innerHTML = '<i class="fas fa-info-circle"></i>';
            toast.className = 'notification-toast';
        }

        toastMessage.textContent = message;
        toast.classList.add('show');

        // Auto hide after 3 seconds
        setTimeout(() => {
          toast.classList.remove('show');
        }, 3000);
      }

      // Initialize the application when DOM is loaded
      document.addEventListener('DOMContentLoaded', init);

      // Make functions available globally for onclick handlers
      window.switchCamera = switchCamera;
      window.toggleDeviceAudio = toggleDeviceAudio;
    </script>
  </body>
</html>
